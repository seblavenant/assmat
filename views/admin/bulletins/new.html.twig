{% extends 'admin/layout.html.twig' %}

{% block body %}
    <div class="row">
        <div id="breadcrumb" class="col-xs-12">
            <ol class="breadcrumb">
                <li><a href="{{ path('admin_index') }}">Dashboard</a></li>
                <li><a href="{{ path('admin_contrats') }}">Mes contrats</a></li>
                <li><a href="{{ path('admin_bulletins', { contratId : contratId }) }}">Bulletins</a></li>
                <li>Nouveau bulletin</li>
            </ol>
        </div>
    </div>

    {{ form_widget(bulletinForm) }}

<div class="row full-calendar">
    <div class="col-sm-3">
        <div id="external-events">
            <h4 class="page-header" id="events-templates-header">Evénements</h4>
            <div class="external-event">Absence payée</div>
            <div class="external-event">Absence non payée</div>
            <div class="external-event">Congé payé</div>
        </div>
    </div>
    <div class="col-sm-9">
        <div id="calendar"></div>
    </div>
</div>

{% endblock %}

{% block specificsJavascripts %}
<script>
$(document).ready(function()
{
    $('#external-events div.external-event').each(function()
    {
        $(this).data('eventObject', {
            title: $.trim($(this).text())
        });
        $(this).draggable({
            zIndex: 999,
            revert: true,
            revertDuration: 0
        });
    });

    var calendar = $('#calendar').fullCalendar({
        events: [
            {% for evenement in evenements %}
            {
                start: '{{ evenement.date | date('Y-m-d') }}T{{ evenement.heureDebut | date('H:i:s') }}',
                end: '{{ evenement.date | date('Y-m-d') }}T{{ evenement.heureFin | date('H:i:s') }}'
            },
            {% endfor %}
        ],
        header: {
            left: 'prev,next today',
            center: '',
            right: ''
        },
        defaultView: 'agendaWeek',
        selectable: true,
        lang: 'fr',
        editable: true,
        droppable: true,
        selectHelper: true,
        unselectAuto: true,
        select: function(start, end, allDay) {
            console.log('select');
            $.ajax({
                method: 'POST',
                url: '{{ path('admin_evenement_set', {contratId: contratId}) }}',
                data: {
                    evenement: {
                        date : start.format('YYYY-MM-DD'),
                        heureDebut : start.format('HH:mm'),
                        heureFin : end.format('HH:mm'),
                        contratId : '{{ contratId }}',
                        type : 1
                    }
                }
            })
            .success(function(msg)
            {
                calendar.fullCalendar('renderEvent', {
                    title: '',
                    description: '',
                    start: start.format('YYYY-MM-DD HH:mm:ss'),
                    end: end.format('YYYY-MM-DD HH:mm:ss'),
                }, true);
            })
            .error(function(Xhr, textStatus)
            {
                console.log('error', Xhr, textStatus);
            })
            ;
        },
        eventDrop: function(event, delta, revertFunc) {
            console.log('eventDrop');
            console.log(event.source.events[0]);
        },
        drop: function(date, allDay) {
            console.log('drop');
            var originalEventObject = $(this).data('eventObject');
            var copiedEventObject = $.extend({}, originalEventObject);
            copiedEventObject.start = date;
            copiedEventObject.allDay = allDay;
            $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
        },
        eventClick: function(calEvent, jsEvent, view) {
            console.log('eventClick');
            if(confirm('Etes vous sur de vouloir supprimer cet événement ?'))
            {
                calendar.fullCalendar('removeEvents' , function(ev){
                    return (ev._id == calEvent._id);
                });
            };
        }
    });
});
</script>
{% endblock %}